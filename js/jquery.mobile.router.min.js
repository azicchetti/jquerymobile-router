/*!
 * jQueryMobile-router v0.6
 * http://github.com/azicchetti/jquerymobile-router
 *
 * Copyright 2011 (c) Andrea Zicchetti
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://github.com/azicchetti/jquerymobile-router/blob/master/MIT-LICENSE.txt
 * http://github.com/azicchetti/jquerymobile-router/blob/master/GPL-LICENSE.txt
 */
(function(a){a(document).bind("mobileinit",function(){function d(a){if(c)console.log(a)}var b=a.extend({fixFirstPageDataUrl:false,firstPageDataUrl:"index.html",ajaxApp:false},a.mobile.jqmRouter||{});var c=true;var e=null,f=null;a(document).bind("pagebeforechange",function(b,c){if(typeof c.toPage==="string"){var d=a.mobile.path.parseUrl(c.toPage);e=f;f=d;if(d.hash.indexOf("?")!==-1){var g=d.hash.replace(/\?.*$/,"");c.options.dataUrl=d.href;if(a.mobile.activePage&&g.replace(/^#/,"")==a.mobile.activePage.jqmData("url")){c.options.allowSamePageTransition=true;a.mobile.changePage(a(g),c.options)}else{a.mobile.changePage(a(g),c.options)}b.preventDefault()}}});if(b.fixFirstPageDataUrl){a(document).ready(function(){if(!window.location.pathname.match("/$")){return}var c=a(":jqmData(role='page')").first();var d=c.jqmData("url"),e=window.location.pathname+b.firstPageDataUrl+window.location.search+window.location.hash;if(d!=e){c.attr("data-url",e).jqmData("url",e)}})}a.mobile.Router=function(c,d,e){this.routes={pagebeforecreate:null,pagecreate:null,pagebeforeshow:null,pageshow:null,pagebeforehide:null,pagehide:null,pageinit:null,pageremove:null};this.evtLookup={bc:"pagebeforecreate",c:"pagecreate",bs:"pagebeforeshow",s:"pageshow",bh:"pagebeforehide",h:"pagehide",i:"pageinit",rm:"pageremove"};this.routesRex={};this.conf=a.extend({},b,e||{});this.defaultHandlerEvents={};if(this.conf.defaultHandlerEvents){var f=this.conf.defaultHandlerEvents.split(",");for(var g=0;g<f.length;g++){this.defaultHandlerEvents[this.evtLookup[f[g]]]=f[g]}}this.add(c,d)};a.extend(a.mobile.Router.prototype,{add:function(b,c){if(!b)return;var e=this,f=[];if(b instanceof Array){a.each(b,a.proxy(function(a,b){this.add(b,c)},this))}else{a.each(b,function(a,b){if(typeof b=="string"||typeof b=="function"){if(e.routes.pagebeforeshow===null){e.routes.pagebeforeshow={}}e.routes.pagebeforeshow[a]=b;if(!e.routesRex.hasOwnProperty(a)){e.routesRex[a]=new RegExp(a)}}else{var c,f=b.events.split(","),g;for(c=0;c<f.length;c++){g=e.evtLookup[f[c]];if(e.routes.hasOwnProperty(g)){if(e.routes[g]===null){e.routes[g]={}}e.routes[g][a]=b.handler;if(!e.routesRex.hasOwnProperty(a)){e.routesRex[a]=new RegExp(a)}}else{d("can't set unsupported route "+f[c])}}}});a.each(e.routes,function(a,b){if(b!==null){f.push(a)}});if(!this.userHandlers)this.userHandlers={};a.extend(this.userHandlers,c||{});this._detachEvents();if(f.length>0){this._liveData={events:f.join(" "),handler:function(a,b){e._processRoutes(a,b,this)}};a(":jqmData(role='page'),:jqmData(role='dialog')").live(this._liveData.events,this._liveData.handler)}}},_processRoutes:function(b,c,g){var h=this,i,j,k,l=0;if(b.type in{pagebeforehide:true,pagehide:true,pageremove:true}){i=e;e=undefined}else{i=f;f=undefined}do{if(!i){if(g){k=a(g);i=k.jqmData("url");if(i){if(k.attr("id")==i)i="#"+i;i=a.mobile.path.parseUrl(i)}}}else if(g&&!a(g).jqmData("url")){return}if(!i)return;j=!this.conf.ajaxApp?i.hash:i.pathname+i.search+i.hash;if(j.length==0){i=""}l++}while(j.length==0&&l<=1);var m=false;a.each(this.routes[b.type],function(a,e){var f,i;if(f=j.match(h.routesRex[a])){if(typeof e=="function"){i=e}else if(typeof h.userHandlers[e]=="function"){i=h.userHandlers[e]}if(i){try{i.apply(h.userHandlers,[b.type,f,c,g,b]);m=true}catch(k){d(k)}}}});if(!m&&this.conf.defaultHandler&&this.defaultHandlerEvents[b.type]){if(typeof this.conf.defaultHandler=="function"){try{this.conf.defaultHandler.apply(h.userHandlers,[b.type,c,g,b])}catch(n){d(n)}}}},_detachEvents:function(){if(this._liveData){a(":jqmData(role='page'),:jqmData(role='dialog')").die(this._liveData.events,this._liveData.handler)}},destroy:function(){this._detachEvents();this.routes=this.routesRex=null},getParams:function(b){if(!b)return null;var c={},d;var e=b.slice(b.indexOf("?")+1).split("&");a.each(e,function(a,b){d=b.split("=");if(c[d[0]]){if(!(c[d[0]]instanceof Array)){c[d[0]]=[c[d[0]]]}c[d[0]].push(d[1])}else{c[d[0]]=d[1]}});if(a.isEmptyObject(c))return null;return c}})})})(jQuery)
